# ZENGTO Web Release & Operations Runbook（对标版）

## 1. 文档目的

定义环境策略、发布流程、灰度与回滚、故障处理和职责分工，确保可持续稳定交付。

## 2. 环境与分支策略

- 环境：`dev` / `staging` / `production`
- 分支：`feature/*` -> `main`
- 发布分支：`release/YYYY-MM-DD`

规则：

- 所有 schema 变更必须先走 staging。
- 生产发布只能来自通过验证的 release 分支。

## 3. CI/CD 流程

## 3.1 PR 阶段（必过）

- lint
- typecheck
- unit test
- contract test
- build

## 3.2 合并到 main

- 自动部署 staging。
- 自动执行 smoke + API health check。
- 生成变更摘要（changelog）。

## 3.3 发布到生产

1. 发布评审通过。
2. 先发布 API 与 worker（向后兼容）。
3. 再发布 Web。
4. 执行灰度与观测。

## 4. 灰度策略

- 第一阶段：5% 流量，观察 30 分钟。
- 第二阶段：20% 流量，观察 60 分钟。
- 第三阶段：100% 全量。

中止条件：

- API 5xx > 2%。
- 核心漏斗成功率下降 > 10%。
- 前端错误率显著异常。

## 5. 迁移与数据变更

- DDL 采用“向前兼容”策略：先加字段后切换读写再删旧字段。
- 大表变更必须离峰执行并有回滚脚本。
- 迁移脚本需具备幂等性。

## 6. 发布前检查清单

- OpenAPI 合同与实现一致。
- feature flags 与本次发布目标一致。
- 数据迁移已在 staging 验证。
- 监控与告警规则已更新。
- 回滚方案演练完成。

## 7. 发布后检查清单

- 关键路径 smoke：Study/Practice/Analyze/Coach。
- 关键指标：请求量、错误率、时延。
- 关键漏斗：提交、完成、教练动作执行。
- 重点日志采样检查无异常。

## 8. 回滚策略

## 8.1 触发条件

- 核心业务链路不可用。
- 数据一致性风险。
- 高严重级安全问题。

## 8.2 回滚动作

1. Web 回滚到上个稳定版本。
2. 关闭高风险 feature flags。
3. 必要时暂停 solver 队列新任务。
4. 执行 DB 回滚或补偿脚本。

## 8.3 回滚后动作

- 发布事故公告（内部）。
- 生成 RCA（根因分析）。
- 输出修复与防复发计划。

## 9. 监控与告警

- API：RPS、P95/P99、4xx/5xx。
- Queue：等待时长、堆积长度、失败重试次数。
- Worker：CPU/GPU 使用率、任务吞吐。
- Coach：请求成功率、工具调用失败率、延迟。

告警分级：

- P1：核心链路中断，立即处理。
- P2：性能退化，30 分钟内处理。
- P3：可延后处理的异常。

## 10. 值班与协同

- On-call 轮值：Backend / Web / SRE / Data 各 1 人。
- 事故频道：统一即时通信频道 + 事故单。
- 协作时序：识别 -> 缓解 -> 修复 -> 复盘。

## 11. 安全运营

- 每周审计高风险操作日志。
- 每月执行依赖漏洞扫描。
- 每季度执行权限与密钥轮换。

## 12. SLA/SLO 报告

- 周报：可用性、错误率、时延、事故统计。
- 月报：SLO 达成率、容量趋势、优化计划。

