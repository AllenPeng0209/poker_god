# ZENGTO AI Coach Spec（全模块右侧教练）

## 1. 文档目的

定义 AI 教练在 Web 各模块中的统一交互、上下文策略、工具调用、质量门槛与安全规范，确保“能解释、能执行、可审计”。

## 2. 产品定位

- 角色：策略教练，不是泛聊天机器人。
- 核心价值：把复杂策略转化为“当前用户可执行的下一步动作”。
- 形态：Cursor 风格右侧面板，支持跨模块上下文注入。

## 3. 交互规范

## 3.1 入口与布局

- 固定入口：页面右上角 `AI Coach`。
- 快捷键：`Cmd/Ctrl + ]` 打开/关闭。
- 宽度状态：`collapsed` / `half` / `full`。
- 会话保持：同模块内保持上下文；跨模块需显式确认是否携带上下文。

## 3.2 模式切换

- `Explain`：解释当前节点/结果的策略逻辑。
- `Fix`：针对错误生成修复动作。
- `Drill`：一键生成训练集。
- `Plan`：产出 7 天计划与复盘点。

## 3.3 上下文标签

- `@当前节点`
- `@当前手牌`
- `@本次训练`
- `@我的报告`
- `@求解结果`

约束：每次最多注入 3 个上下文源，超出需用户确认。

## 4. 模块能力矩阵

| 模块 | 读取上下文 | 可执行动作 |
|---|---|---|
| Study | 节点策略、EV、阻断信息 | 创建 Drill、收藏节点、加入计划 |
| Solver | 参数树、求解状态、结果对比 | 生成模板、重跑任务、创建训练 |
| Practice | 答题记录、错误分布、耗时 | 生成错题本、调整难度、安排复训 |
| Analyze | 手牌详情、EV loss、错误标签 | 生成修复计划、批量 Drill |
| Reports | 统计项、样本量、趋势 | 优先级排序、目标设定 |
| Arena | 对战记录、关键手牌 | 赛后复盘摘要、下场对策 |

## 5. 输出协议（强制）

每次助手回复必须输出以下 5 段：

1. `结论`
2. `依据数据`
3. `行动建议`
4. `风险提示`
5. `置信度`

若无法提供充分依据，必须返回：`证据不足，建议补充 ...`。

## 6. 编排与工具调用

## 6.1 调用链

1. Context Assembler：收集请求上下文。
2. Policy Guard：检查数据权限和策略规则。
3. Planner：决定是否调用工具。
4. Tool Runner：执行结构化工具调用。
5. Responder：组装输出协议并返回。
6. Audit Writer：写入审计日志。

## 6.2 Tool API

- `study.get_node(node_id)`
- `solver.get_job(job_id)`
- `trainer.create_drill(payload)`
- `trainer.get_session(session_id)`
- `analyzer.get_hand(hand_id)`
- `reports.get_metric(metric_key, window)`
- `plans.upsert_weekly_plan(payload)`

## 6.3 Action Confirmation 机制

以下动作必须二次确认：

- 批量生成 > 100 题 Drill。
- 覆盖已有周计划。
- 发起高成本求解任务（credits 超阈值）。

## 7. Prompt 策略

## 7.1 System Prompt（摘要）

- 只输出策略相关、可执行建议。
- 不确定时必须明确不确定性来源。
- 不可编造数据，必须引用 context 或 tool 结果。
- 不给违规或作弊性建议。

## 7.2 Context Packing

- 优先级：当前页面上下文 > 最近任务 > 用户长期画像。
- Token 预算：
  - 当前上下文 60%
  - 近期历史 30%
  - 长期记忆 10%

## 7.3 Memory Policy

- 默认记忆窗口：最近 30 天。
- 用户可切换“隐私模式”（仅当前会话，不入长期记忆）。
- 个人敏感信息不进入模型长期记忆。

## 8. 质量评估体系

## 8.1 在线指标

- 首 token 时延（P95）
- 工具调用成功率
- 行动按钮点击率（Drill/Plan）
- 用户“有帮助”反馈率

## 8.2 离线评测

- 策略准确性（与基线解对比）
- 证据引用完整率
- 风险提示触发准确率
- 幻觉率（无依据结论占比）

目标阈值：

- 引用完整率 >= 90%
- 幻觉率 <= 2%
- Action 可执行率 >= 80%

## 9. 安全与合规

- 所有工具调用走服务端，不允许前端直连敏感资源。
- 权限不足时返回最小化信息，不泄露他人数据。
- 关键对话与动作写 `audit_logs`。
- 支持内容安全过滤（辱骂、违法、作弊请求）。

## 10. 降级与故障策略

- LLM 主供应商超时：切换备用供应商。
- 工具不可用：返回“仅基于现有上下文”的低置信度答案。
- 全链路故障：降级到静态建议模板 + 稍后重试。

## 11. 验收标准

- 所有模块都可打开右侧教练并发起会话。
- 至少 3 个动作类能力可闭环（创建 Drill、创建 Plan、跳转节点）。
- 输出协议字段缺失率为 0。
- 安全回归测试通过（越权、注入、敏感泄露）。

